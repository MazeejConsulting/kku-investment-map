<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ø®Ø§Ø±Ø·Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ù„Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Tahoma', 'Arial', sans-serif;
      background-color: #f5f5f5;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container { display: flex; flex-direction: column; flex: 1; }

    .header {
      background: linear-gradient(135deg, #1a5f3f 0%, #2d8659 100%);
      color: white;
      padding: 16px 18px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .logo {
      width: 72px; height: 72px;
      display: flex; align-items: center; justify-content: center;
    }
    .logo img { width: 100%; height: 100%; object-fit: contain; }

    .header-content h1 { font-size: 22px; font-weight: bold; margin: 0; }
    .header-content p { font-size: 13px; margin-top: 6px; opacity: .9; }

    .content {
      display: flex;
      flex: 1;
      overflow: hidden;
      height: calc(100vh - 120px - 60px);
    }

    .map-container { flex: 1; position: relative; background: #e9f2ec; }
    #map { width: 100%; height: 100%; }

    .sidebar {
      width: 380px;
      background-color: white;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      padding: 16px;
      box-shadow: -2px 0 8px rgba(0,0,0,.1);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .sidebar h2 {
      color: #1a5f3f;
      font-size: 16px;
      margin: 0;
      border-bottom: 2px solid #2d8659;
      padding-bottom: 10px;
    }

    .statistics {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    .statistics h3 {
      color: #1a5f3f;
      font-size: 14px;
      margin-bottom: 10px;
      text-align: center;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat-item {
      background: #fff;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
    }
    .stat-item .number {
      font-size: 22px;
      font-weight: bold;
      color: #2d8659;
      display: block;
      margin-bottom: 4px;
    }
    .stat-item .label { font-size: 12px; color: #666; }

    .filters {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .filter-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: bold;
      color: #1a5f3f;
      margin-bottom: 6px;
    }
    .filter-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      font-family: 'Tahoma', 'Arial', sans-serif;
      background: white;
      cursor: pointer;
    }
    .filter-group select:focus { outline: none; border-color: #2d8659; }

    .location-item {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: all .2s ease;
      margin-bottom: 10px;
    }
    .location-item:hover {
      background: #e8f5e9;
      border-color: #2d8659;
      box-shadow: 0 2px 6px rgba(45,134,89,.15);
      transform: translateY(-1px);
    }
    .location-item h3 {
      color: #1a5f3f;
      font-size: 15px;
      margin-bottom: 8px;
      font-weight: bold;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 6px;
    }
    .location-item p { font-size: 12px; color: #666; margin: 4px 0; line-height: 1.5; }
    .location-item p strong { color: #2d8659; }

    .leaflet-popup-content {
      direction: rtl;
      text-align: right;
      font-family: 'Tahoma','Arial',sans-serif;
    }

    .legend {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      margin-top: 8px;
    }
    .legend h3 { color: #1a5f3f; font-size: 13px; margin-bottom: 8px; }

    .empty-state {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 10px;
      color: #666;
      text-align: center;
      padding: 18px;
      background: rgba(255,255,255,.82);
    }
    .empty-state h3 { margin: 0; }
    .empty-state p { font-size: 13px; }

    .btn-retry {
      background: linear-gradient(135deg, #1a5f3f 0%, #2d8659 100%);
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .btn-retry:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(26,95,63,.25);
    }

    .footer {
      background: #f0f0f0;
      border-top: 1px solid #ddd;
      padding: 12px 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 13px;
      color: #555;
      flex-wrap: wrap;
    }
    .footer img { height: 34px; object-fit: contain; }
    .footer a { color: #1a5f3f; text-decoration: none; font-weight: bold; }
    .footer a:hover { text-decoration: underline; }

    /* âœ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬ÙˆØ§Ù„: Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù„Ù‡Ø§ Ø§Ø±ØªÙØ§Ø¹ ÙˆØ§Ø¶Ø­ */
    @media (max-width: 768px) {
      .content {
        flex-direction: column;
        height: auto;
        overflow: visible;
      }
      .map-container {
        height: 60vh;     /* Ø¬Ø±Ù‘Ø¨ 65vh Ø¥Ø°Ø§ ØªØ¨ØºØ§Ù‡Ø§ Ø£ÙƒØ¨Ø± */
        min-height: 330px;
      }
      #map { height: 100%; min-height: 330px; }

      .sidebar {
        width: 100%;
        max-height: none;
        border-left: none;
        border-top: 1px solid #ddd;
        overflow-y: visible;
      }

      .header-content h1 { font-size: 18px; }
      .logo { width: 58px; height: 58px; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="logo">
      <img src="logo.svg" alt="Ø´Ø¹Ø§Ø± Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ Ø®Ø§Ù„Ø¯">
    </div>
    <div class="header-content">
      <h1>Ø§Ù„Ø®Ø§Ø±Ø·Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ù„Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h1>
      <p>Ø®Ø±ÙŠØ·Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±Ø©</p>
    </div>
  </div>

  <div class="content">
    <div class="map-container">
      <div id="map"></div>
      <div class="empty-state" id="emptyState">
        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹</p>
        <button class="btn-retry" id="retryBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
      </div>
    </div>

    <div class="sidebar">
      <div class="statistics">
        <h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="number" id="totalContracts">0</span>
            <span class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚ÙˆØ¯</span>
          </div>
          <div class="stat-item">
            <span class="number" id="totalLocations">0</span>
            <span class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</span>
          </div>
        </div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label for="filterSource">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
          <select id="filterSource">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filterBuilding">ğŸ¢ Ø§Ù„Ù…Ø¨Ù†Ù‰:</label>
          <select id="filterBuilding">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filterStatus">ğŸ“‹ Ø§Ù„Ø­Ø§Ù„Ø©:</label>
          <select id="filterStatus">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <!-- Ø³ÙŠØªÙ… ØªØ«Ø¨ÙŠØªÙ‡Ø§ Ø¥Ù„Ù‰: Ù…Ù†ØªÙ‡ÙŠØŒ Ø³Ø§Ø±ÙŠ -->
          </select>
        </div>
      </div>

      <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</h2>
      <div id="locationsList"></div>

      <div class="legend">
        <h3>ğŸ” Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>
        <div style="font-size: 12px; color: #666; line-height: 1.6;">
          <p style="margin: 8px 0;"><strong>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ÙˆÙ‚Ø¹</strong> Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
          <p style="margin: 8px 0;"><strong>Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³</strong> Ù„Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØµØºÙŠØ±</p>
          <p style="margin: 8px 0;"><strong>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</strong> Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</p>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <span>Ø·ÙˆØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø´Ø±ÙƒØ© Ù…Ø²ÙŠØ¬ Ù„Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</span>
    <a href="https://mazeej.com.sa/" target="_blank" rel="noreferrer">
      <img src="mazeej-logo.png" alt="Ø´Ø¹Ø§Ø± Ù…Ø²ÙŠØ¬">
    </a>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
  let map = null;
  let allSites = [];
  let markers = [];

  let currentFilters = {
    source: '',
    building: '',
    status: ''
  };

  function initMap() {
    map = L.map('map', { zoomControl: true }).setView([18.2164, 42.5053], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    // âœ… Ù…Ù‡Ù… Ù„Ù„Ø¬ÙˆØ§Ù„: ÙŠØ¶Ù…Ù† Ø£Ù† Leaflet ÙŠØ­Ø³Ø¨ Ø§Ù„Ù…Ù‚Ø§Ø³ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø±Ø¶
    setTimeout(() => map.invalidateSize(), 300);
  }

  function showEmptyState(show) {
    const empty = document.getElementById('emptyState');
    const mapEl = document.getElementById('map');
    empty.style.display = show ? 'flex' : 'none';
    mapEl.style.display = show ? 'none' : 'block';
  }

  function normalizeFileNo(raw) {
    const s = (raw ?? '').toString().trim();
    if (s === '') return '';
    const n = parseInt(s, 10);
    if (Number.isFinite(n)) return String(n).padStart(3, '0');
    return s;
  }

  function isValidCoord(lat, lon) {
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return false;
    if (Math.abs(lat) > 90 || Math.abs(lon) > 180) return false;
    return true;
  }

  function populateFilters(sites) {
    // Ø¬Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ù…Ø¨Ù†Ù‰ ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const sources = new Set();
    const buildings = new Set();

    sites.forEach(site => {
      const d = site.details || {};
      const src = (d['Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±'] ?? '').toString().trim();
      const bld = (d['Ø§Ù„Ù…Ø¨Ù†Ù‰'] ?? '').toString().trim();
      if (src) sources.add(src);
      if (bld) buildings.add(bld);
    });

    // ÙÙ„ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹
    const sourceSelect = document.getElementById('filterSource');
    sourceSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option>';
    Array.from(sources).sort().forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      sourceSelect.appendChild(opt);
    });

    // ÙÙ„ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰
    const buildingSelect = document.getElementById('filterBuilding');
    buildingSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option>';
    Array.from(buildings).sort().forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      buildingSelect.appendChild(opt);
    });

    // âœ… ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ø«Ø§Ø¨Øª ÙÙ‚Ø·: Ù…Ù†ØªÙ‡ÙŠ + Ø³Ø§Ø±ÙŠ)
    const statusSelect = document.getElementById('filterStatus');
    statusSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>';
    ['Ù…Ù†ØªÙ‡ÙŠ', 'Ø³Ø§Ø±ÙŠ'].forEach(status => {
      const opt = document.createElement('option');
      opt.value = status;
      opt.textContent = status;
      statusSelect.appendChild(opt);
    });

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙÙ„Ø§ØªØ± (Ø§Ø³ØªØ®Ø¯Ù… onchange Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±)
    sourceSelect.onchange = (e) => {
      currentFilters.source = e.target.value;
      filterAndDisplaySites();
    };

    buildingSelect.onchange = (e) => {
      currentFilters.building = e.target.value;
      filterAndDisplaySites();
    };

    statusSelect.onchange = (e) => {
      currentFilters.status = e.target.value;
      filterAndDisplaySites();
    };
  }

  function filterSites(sites) {
    return sites.filter(site => {
      const d = site.details || {};

      if (currentFilters.source) {
        if ((d['Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±'] ?? '').toString().trim() !== currentFilters.source) return false;
      }

      if (currentFilters.building) {
        if ((d['Ø§Ù„Ù…Ø¨Ù†Ù‰'] ?? '').toString().trim() !== currentFilters.building) return false;
      }

      if (currentFilters.status) {
        // âœ… ÙÙ‚Ø· Ø³Ø§Ø±ÙŠ/Ù…Ù†ØªÙ‡ÙŠØŒ ÙˆÙ…Ø§ Ø¹Ø¯Ø§Ù‡Ø§ ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª"
        if ((d['Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯'] ?? '').toString().trim() !== currentFilters.status) return false;
      }

      return true;
    });
  }

  function filterAndDisplaySites() {
    const filtered = filterSites(allSites);
    displaySites(filtered);
  }

  function displaySites(sites) {
    if (!map) initMap();

    // Ù…Ø³Ø­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const list = document.getElementById('locationsList');
    list.innerHTML = '';

    // ================= Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª =================
    // Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù‚ÙˆØ¯ (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±)
    const uniqueContracts = new Set();

    // Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹: Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª "Ù…Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±" + ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙØ§Ø¶ÙŠ
    let locationsCount = 0;

    sites.forEach(site => {
      // Ø§Ù„Ø¹Ù‚ÙˆØ¯
      const fileKey = normalizeFileNo(site?.details?.['Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù']);
      // Ù„Ùˆ ØªØ¨ÙŠ ØªØ­Ø³Ø¨ 000 ÙƒØ¹Ù‚Ø¯ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø´Ø±Ø· Ø§Ù„ØªØ§Ù„ÙŠ
      if (fileKey && fileKey !== '000') uniqueContracts.add(fileKey);

      // Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (ØµÙÙˆÙ Ø¨Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)
      const latRaw = (site?.lat ?? '').toString().trim();
      const lonRaw = (site?.lon ?? '').toString().trim();
      if (latRaw === '' || lonRaw === '') return;

      const lat = Number(latRaw);
      const lon = Number(lonRaw);
      if (!isValidCoord(lat, lon)) return;

      locationsCount++;
    });

    document.getElementById('totalContracts').textContent = uniqueContracts.size;
    document.getElementById('totalLocations').textContent = locationsCount;
    // =============================================

    if (!sites || sites.length === 0) {
      list.innerHTML = '<div style="text-align:center; padding: 16px; color:#999; font-size: 13px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</div>';
      setTimeout(() => map.invalidateSize(), 200);
      return;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
    sites.forEach((location) => {
      const latRaw = (location?.lat ?? '').toString().trim();
      const lonRaw = (location?.lon ?? '').toString().trim();
      if (latRaw === '' || lonRaw === '') return;

      const lat = Number(latRaw);
      const lon = Number(lonRaw);
      if (!isValidCoord(lat, lon)) return;

      const details = location.details || {};
      const activityTitle = (details['Ø§Ù„Ù†Ø´Ø§Ø·'] ?? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯').toString().trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

      // Popup
      let popupContent = '<div style="direction: rtl; text-align: right; font-family: Tahoma, Arial, sans-serif;">';
      popupContent += '<h4 style="color:#1a5f3f; margin-bottom:10px; font-size:15px; font-weight:bold; border-bottom:1px solid #eee; padding-bottom:5px;">'
        + activityTitle + '</h4>';

      const cardFields = [
        { key: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø±', label: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹' },
        { key: 'Ø§Ù„Ù…Ø¨Ù†Ù‰', label: 'Ø§Ù„Ù…Ø¨Ù†Ù‰' },
        { key: 'Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±', label: 'Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±' },
        { key: 'Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©', label: 'Ø§Ù„Ø£Ø¬Ø±Ø©' },
        { key: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯', label: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯' }
      ];

      cardFields.forEach(field => {
        const value = (details[field.key] ?? '').toString().trim();
        if (value) {
          popupContent += `<p style="margin:5px 0; font-size:12px; color:#333;"><strong style="color:#2d8659;">${field.label}:</strong> ${value}</p>`;
        } else {
          popupContent += `<p style="margin:5px 0; font-size:12px; color:#999;"><strong style="color:#2d8659;">${field.label}:</strong> <em>ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em></p>`;
        }
      });

      popupContent += `<p style="margin:5px 0; font-size:12px; color:#333;"><strong style="color:#2d8659;">Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}</p>`;
      popupContent += '</div>';

      const marker = L.marker([lat, lon]).addTo(map).bindPopup(popupContent);
      markers.push(marker);

      // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      const item = document.createElement('div');
      item.className = 'location-item';

      let html = `<h3>${activityTitle}</h3>`;
      cardFields.forEach(field => {
        const value = (details[field.key] ?? '').toString().trim();
        if (value) html += `<p><strong>${field.label}:</strong> ${value}</p>`;
        else html += `<p style="color:#999;"><strong>${field.label}:</strong> <em>ØºÙŠØ± Ù…Ø­Ø¯Ø¯</em></p>`;
      });
      html += `<p><strong>Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}</p>`;
      item.innerHTML = html;

      item.addEventListener('click', () => {
        map.setView([lat, lon], 15);
        setTimeout(() => marker.openPopup(), 250);
      });

      list.appendChild(item);
    });

    // Fit bounds
    if (markers.length > 0) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.1));
    }

    // âœ… Ù…Ù‡Ù… Ù„Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©/Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    setTimeout(() => {
      if (map) map.invalidateSize();
    }, 300);
  }

  async function loadData() {
    try {
      showEmptyState(false);

      const res = await fetch('sites.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('sites.json not found');

      const sites = await res.json();
      if (!Array.isArray(sites) || sites.length === 0) throw new Error('empty data');

      allSites = sites;

      if (!map) initMap();
      populateFilters(allSites);
      displaySites(allSites);

      showEmptyState(false);

    } catch (err) {
      console.error('Load error:', err);
      showEmptyState(true);
    }
  }

  // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
  document.getElementById('retryBtn').addEventListener('click', () => loadData());

  // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  window.addEventListener('load', loadData);

  // âœ… Ù„Ù„Ø¬ÙˆØ§Ù„/ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø©
  window.addEventListener('resize', () => {
    if (map) map.invalidateSize();
  });

</script>
</body>
</html>
